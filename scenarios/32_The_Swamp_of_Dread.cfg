#textdomain wesnoth-h2tt

#define SCENARIO_TURN_LIMIT
35#enddef


[scenario]
    id,map_file,name=32_The_Swamp_of_Dread,32_The_Swamp_of_Dread.map,_"The Swamp of Dread"
    next_scenario,victory_when_enemies_defeated=00_The_Great_Continent,no
    {SCHEDULE_DYNAMIC_NIGHT OFFSET=-6}
    turns={SCENARIO_TURN_LIMIT}
    {SCENARIO_MUSIC revelation.ogg}
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE 50 FOG=yes SHROUD=yes}
    
    #############################
    # LISAR
    #############################
    [event] name=prestart {UNSTORE_NPC Lisar x,y=17,12 side,facing=2,se} [/event]
    [side]
        side,controller,color=2,ai,wesred
        gold,income={ON_DIFFICULTY4 20 30 40 40},{ON_DIFFICULTY4 1 4 10 10} # 3 villages, and probably >>3 upkeep
        recruit=Fencer
        fog,shroud=yes,yes # so she can share vision with Konrad once they ally
        team_name,user_team_name=wesnoth,_"Li’sar"
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 2}
    {STARTING_VILLAGES 2 5}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Heavy Infantryman" {ON_DIFFICULTY4 1 1 2 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Bowman"            {ON_DIFFICULTY4 1 1 2 2}}
    [event]
        name,first_time_only=side 2 turn,no
        {RESET_SIDE_AI 2 defensive 0.2 0.6}
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 2 3,4}
        {RETREAT_WHEN_WEAK 2 {ON_DIFFICULTY4 0-4 0-5 0-6 0-6} (
            {GOAL_LOCATION 3 x,y=18,12}
            {GOAL_LOCATION 2 x,y=20,10}
            {GOAL_LOCATION 2 x,y=17,14}
            {GOAL_LOCATION 1 x,y=15,13}
        )}
        {MODIFY_SIDE_AI 2 ([avoid]
            x,y,radius=8,25,7 # stay away from the southwest undead leader; that one's there for Konrad to fight
        [/avoid])}
    [/event]
    
    #############################
    # UNDEAD
    #############################
    [side]
        side,controller,color=3,ai,white
        type,id,facing=Death Squire,leader2,nw
        gold,income={ON_DIFFICULTY4 10 20 40 40},{ON_DIFFICULTY4 -2 0 4 4} # 2 village, ~2 upkeep
        recruit=Walking Corpse
        team_name,user_team_name=undead,_"Undead"
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 2}
    {STARTING_VILLAGES 3 8}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Soulless" {ON_DIFFICULTY4 0 1 2 2}}
    {RECRUIT_UNIT_VARIATIONS 3 "Walking Corpse" none,none,saurian,saurian,horse}
    {RECRUIT_UNIT_VARIATIONS 3 "Soulless"       none,none,saurian,saurian,horse}
    
    [side]
        side,controller,color=4,ai,white
        type,id,name,facing=Lich,Iliah-Malal,_"Iliah-Malal",nw
        gold,income={ON_DIFFICULTY4 15 30 60 60},{ON_DIFFICULTY4 2 8 20 20} # 2 village, ~2 upkeep
        recruit=Walking Corpse
        team_name,user_team_name=undead,_"Undead"
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 2}
    {STARTING_VILLAGES 4 8}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Soulless" {ON_DIFFICULTY4 1 2 4 4}}
    {RECRUIT_UNIT_VARIATIONS 4 "Walking Corpse" none,none,saurian,saurian,horse}
    {RECRUIT_UNIT_VARIATIONS 4 "Soulless"       none,none,saurian,saurian,horse}
    
    [event]
        name,first_time_only=side 3 turn,no
        # make the undead group slowly, so they take a while to overwhlem the player, but when they do fight make them very aggressive
        {RESET_SIDE_AI 3,4 defensive 0.9 0.1}
        {AUTOENRAGE 3 0}
        {AUTOENRAGE 4 0}
        {RETREAT_WHEN_WEAK 4 {ON_DIFFICULTY4 0-5 0-7 0-9 0-9} (
            {GOAL_LOCATION 3 x,y=36,22}
            {GOAL_LOCATION 2 x,y=33,21}
            {GOAL_LOCATION 1 x,y=39,19}
            {GOAL_LOCATION 1 x,y=40,17}
            {GOAL_LOCATION 1 x,y=33,24}
            {GOAL_LOCATION 1 x,y=38,22}
            {GOAL_LOCATION 0.1 x,y,radius=37,22,1}
        )}
        {MODIFY_SIDE_AI 3 ({GOAL_SEEK_SIDE 2 1 0})} # southwest leader prefers attacking Konrad
    [/event]
    
    # undead guard side, to avoid affecting upkeep, LIMIT_CONTEMPORANEOUS_RECRUITS, and RETREAT_WHEN_WEAK
    [side]
        side,controller,color=5,ai,white
        no_leader,hidden=yes,yes
        team_name=undead
    [/side]
        
    # beasts
    [side]
        side,controller,color=6,ai,brown
        no_leader,hidden=yes,yes
        team_name=beasts
    [/side]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {PLACE_IMAGE scenery/mine-abandoned.png 34 3} # these mines are where Li'sar emerged from, and their locations are used in the event explaining this
        {PLACE_IMAGE scenery/mine-abandoned.png 37 4}
        
        #############################
        # BEASTS
        #############################
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Frost Stoat" "Frost Stoat" "Frost Stoat"    "Frost Stoat"   }) 8 10 ({ROLE beasts}{ZONE_GUARDIAN 8 10 (radius=4 {FILTER role=beasts})}) }
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"        "Frost Stoat" "Frost Stoat"    "Frost Stoat"   }) 6 12 ({ROLE beasts}{ZONE_GUARDIAN 6 12 (radius=4 {FILTER role=beasts})}) }
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"        "Frost Stoat" "Frost Stoat"    "Frost Stoat"   }) 8 10 ({ROLE beasts}{ZONE_GUARDIAN 8 10 (radius=4 {FILTER role=beasts})}) }
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"        "none"        "Frost Stoat"    "Frost Stoat"   }) 8 10 ({ROLE beasts}{ZONE_GUARDIAN 8 10 (radius=4 {FILTER role=beasts})}) }
        {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Icemonax"    "Icemonax"    "Great Icemonax" "Great Icemonax"}) 13 4 ({GUARDIAN}) }
        
        #############################
        # LISAR GUARDS
        #############################
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper"     "Shock Trooper"    }) 17 14 ({FACING se}{ZONE_GUARDIAN 17 14 x,y,radius=16,13,2})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"}) 18 11 ({HITPOINTS 28}{FACING se}{ZONE_GUARDIAN 18 11 x,y,radius=17,12,2})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Fencer"            "Fencer"            "Fencer"            "Fencer"           }) 22 12 ({HITPOINTS 11})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Duelist"           "Duelist"           "Master at Arms"    "Master at Arms"   }) 21 14 ({HITPOINTS 23})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Longbowman"        "Longbowman"        "Master Bowman"     "Master Bowman"    }) 21 15 ()}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "Iron Mauler"       "Iron Mauler"       "Iron Mauler"      }) 20 14 ({HITPOINTS 35})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "Bowman"            "Longbowman"        "Longbowman"       }) 20 12 ()}
        
        #############################
        # UNDEAD ATTACKERS
        #############################
        # it matters that we do this after Lisar guards, because some of them spawn at the exact same positions
        {REPEAT ({ON_DIFFICULTY4 2 3 4 4}) ({GENERIC_UNIT 4 "Soulless"       22 12}                   )}
        {REPEAT ({ON_DIFFICULTY4 3 4 5 5}) ({GENERIC_UNIT 4 "Walking Corpse" 21 15}{VARIATION saurian})}
        {REPEAT ({ON_DIFFICULTY4 1 2 3 3}) ({GENERIC_UNIT 4 "Walking Corpse" 21 10}                   )}
        
        # the "second wave" of undead; otherwise Li'sar spends a lot of time not fighting
        {REPEAT ({ON_DIFFICULTY4 1 2 4 4}) (
            {GENERIC_UNIT 4 "Walking Corpse" 35 17}
            {GENERIC_UNIT 4 "Walking Corpse" 35 17} {VARIATION saurian}
        )}
        
        #############################
        # UNDEAD GUARDS
        #############################
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"              "Walking Corpse"    "Soulless"          "Soulless"         })  6 25 ({FACING ne}{ZONE_GUARDIAN  6 25 x,y,radius=8,25,2}{VARIATION saurian})}
        
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Walking Corpse"    "Walking Corpse"    "Soulless"          "Soulless"         }) 33 23 ({FACING nw}{ZONE_GUARDIAN 33 23 x,y,radius=8,25,2}{VARIATION saurian})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"              "Walking Corpse"    "Soulless"          "Soulless"         }) 34 22 ({FACING sw}{ZONE_GUARDIAN 34 22 x,y,radius=8,25,2}{VARIATION saurian})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"              "Walking Corpse"    "Soulless"          "Soulless"         }) 34 23 ({FACING nw}{ZONE_GUARDIAN 34 23 x,y,radius=8,25,2})}
        
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Walking Corpse"    "Walking Corpse"    "Soulless"          "Soulless"         }) 39 18 ({FACING nw}{ZONE_GUARDIAN 39 18 x,y,radius=8,25,2})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"              "Walking Corpse"    "Soulless"          "Soulless"         }) 28 19 ({FACING sw}{ZONE_GUARDIAN 28 19 x,y,radius=8,25,2}{VARIATION saurian})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"              "Walking Corpse"    "Soulless"          "Soulless"         }) 40 18 ({FACING nw}{ZONE_GUARDIAN 40 18 x,y,radius=8,25,2})}
        
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Walking Corpse"    "Walking Corpse"    "Soulless"          "Soulless"         }) 37 21 ({FACING nw}{ZONE_GUARDIAN 37 21 x,y,radius=8,25,2}{VARIATION saurian})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Walking Corpse"    "Walking Corpse"    "Soulless"          "Soulless"         }) 39 23 ({FACING sw}{ZONE_GUARDIAN 39 23 x,y,radius=8,25,2})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"              "Walking Corpse"    "Soulless"          "Soulless"         }) 40 21 ({FACING sw}{ZONE_GUARDIAN 40 21 x,y,radius=8,25,2}{VARIATION saurian})}
        
        #############################
        # KONRAD
        #############################
        {PUT_TO_RECALL_LIST id=Konrad}
        {SCROLL_TO 4 1}
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        {SCREEN_FADER 0,0,0 255 0}
        # do NOT recall companions here, since free recalls are disproportionately strong with how little gold we have
        {RECALL_XY Konrad   4 1} {MODIFY_UNIT id=Konrad   facing se}
        {RECALL_XY Delfador 5 2} {MODIFY_UNIT id=Delfador facing sw}
        {REDRAW}
        
        #############################
        # INITIAL NARRATION
        #############################
        [message]
            speaker=narrator
            message=_"<i>Blue sparks lept from the wizard’s staff as he and his young ward sped away from the rising lava with supernatural haste. The sounds of rupturing earth receeded behind them as they passed other creatures fleeing the flames — beasts; trolls; soldiers of Li’sar’s. For the first time Konrad saw signs of fatigue in the old wizard’s normally inscrutable face.</i>"
        [/message]
        [message]
            speaker=narrator
            message=_"<i>Konrad, Delfador, and their army wandered for four days, lost in lonely corridors and abandoned tunnels under the trackless mountains. What few foodstuffs had been salvaged from the lava dwindled, then vanished entirely. Finally, weakened and battered by their ordeal, Konrad and his party emerged into an unknown valley...</i>"
        [/message]
        
        #############################
        # INITIAL DIALOGUE
        #############################
        {SCREEN_FADER 0,0,0 000 500}
        [change_theme]
        [/change_theme]
        [message]
            speaker=Delfador
            message=_"Oh, my old bones! Long has it been since I exerted myself so, especially on an empty stomach. We were most fortunate that the volcano was old, and the mage of Asheviere’s weak."
        [/message]
        [if] {VARIABLE_CONDITIONAL bm_s30_victory equals lisar} {THEN(
            [message]
                speaker=Delfador
                message=_"But what matters is that you are alive, Konrad, and that we have escaped the caves and found daylight again. And although the volcano deprived us of our chance to capture Li’sar, we still have the Sceptre!"
            [/message]
        )} [/if]
        [if] {VARIABLE_CONDITIONAL bm_s30_victory equals sceptre} {THEN(
            [message]
                speaker=Delfador
                message=_"But what matters is that you are alive, Konrad, and that we have escaped the caves and found daylight again. And we have the Sceptre as well! Despite our difficulties, our quest has been a success."
            [/message]
        )} [/if]
        [if] {VARIABLE_CONDITIONAL bm_s30_victory equals coward} {THEN(
            [message]
                speaker=Delfador
                message=_"But what matters is that you are alive, Konrad, and that we have escaped the caves and found daylight again. If only we had the Sceptre with us... it is surely now buried beyond all hope of reclamation."
            [/message]
        )} [/if]
        [message]
            speaker=Konrad
            message=_"Yes, but look! We are not the only ones who have escaped the caves!"
        [/message]
        
        #############################
        # INTRODUCE LI'SAR
        #############################
        {REVEAL x,y,radius=19,12,4 MULTITURN=yes}
        {SCROLL_TO 19 12}
        {FADE_MUSIC_OUT 500}
        {REPLACE_SCENARIO_MUSIC battle-epic.ogg}
        {APPEND_MUSIC battle.ogg}
        {APPEND_MUSIC casualties_of_war.ogg}
        [message]
            speaker=Lisar # default portrait, so that if she has her Sceptre it's shown in her portrait
            message=_"Keep moving. Don’t get pinned. I know this looks bad; I know we’ve watched countless friends fall in the fires, or rise anew as undead, and that you’re scared."
        [/message]
        [message]
            speaker=Lisar
            message=_"But there is no choice but to fight. Fight, fight or die. Even if others have escaped the lava elsewhere, we’ve no chance of finding them unless we few survivors can first evade these undead."
        [/message]
        {DELAY 250}
        
        #############################
        # DISCUSS LI'SAR
        #############################
        [if] {VARIABLE_CONDITIONAL bm_s30_victory equals coward} {THEN(
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"So, the princess has survived — and she has the Sceptre of Fire! I shouldn’t be surprised; villains often seem hard to finish off, don’t they?

And what’s more, she is fighting an enormous horde of undead! If we keep our distance she may not notice us, and will surely perish at the hands of the dead!"
            [/message]
        )} {ELSE(
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"So, the princess has survived after all. I shouldn’t be surprised; villains often seem hard to finish off, don’t they?

And what’s more, she is fighting an enormous horde of undead! If we keep our distance she may not notice us, and will surely perish at the hands of the dead!"
            [/message]
        )} [/if]
        [message]
            speaker=Konrad
            message=_"On the other hand... we ourselves are weakened from long days of hunger and travel, and these undead will only become stronger with the addition of the bodies of Li’sar’s men — I see many fresh corpses among their numbers already. I wonder if we truly possess the strength to survive alone?"
        [/message]
        [if] {VARIABLE_CONDITIONAL bm_s30_victory equals lisar} {THEN(
            [message]
                speaker=Delfador
                message=_"I have seen firsthand the dangers of the spawn of Asheviere, Konrad, and I have learned the value of swift action against them. Li’sar has already escaped us once! I think it best that we ensure her defeat first, and only afterwards give thought to our escape."
            [/message]
        )} {ELSE(
            [message]
                speaker=Delfador
                message=_"I have seen firsthand the dangers of the spawn of Asheviere, Konrad, and I have learned the value of swift action against them. This may be our only chance to vanquish Li’sar! I think it best that we ensure her defeat first, and only afterwards give thought to our escape."
            [/message]
        )} [/if]
        
        #############################
        # KONRAD'S REBUTTAL
        #############################
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"I have no love for the villain who tried to take my life, Delfador, but neither am I willing to risk my comrades just to spite her. That is how Asheviere fights; more invested in the death of enemies than the life of friends. Did you yourself not tell me <i>“be forgiving, be wise, be kind”</i>?"
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION concerned}
            message=_"No food, no shelter, little gold... Unless all the living stand together against the dead, I fear things shall end badly for us — and from her palace secure in Weldyn, Asheviere will laugh. No, we should approach Li’sar and offer a brief alliance, at least until these undead are defeated."
        [/message]
        [message]
            speaker=Konrad
            message=_"Although she is our enemy, I have come to believe she cares about her soldiers just as we do, and that she is trustworthy enough to honor her word if she agrees not to harm us. I ask you to trust my judgement on this, my mentor."
        [/message]
        [message]
            speaker=Delfador
            message=_"The last time a king asked me to trust him, things ended rather badly for the both of us. Nevertheless, you are my lord and I know you to be growing wise beyond your years, Konrad. Let us reach Li’sar and make your offer."
        [/message]

        #############################
        # OBJECTIVES
        #############################
#define STARVING_NOTE
        [note]
            description= _ "Konrad’s army is starving. Companion loyals (except Delfador) are not recalled automatically"
        [/note]
        [note]
            description= _ "Konrad’s army is starving. Units cannot heal by resting, and regain only 2 hitpoints per turn from villages or healers."
        [/note]
#enddef
        [objectives]
            [objective]
                description= _ "Reach Li’sar before she is slain"
                condition=win
            [/objective]
            [objective]
                description= _ "Then, defeat all enemy leaders"
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
            {STARVING_NOTE}
        [/objectives]
    [/event]
    
    #############################
    # REDUCE HEALING
    #############################
    # disable regular healing completely, then manually heal valid units for 2hp instead.
    # we don't actually check the amount of healing/regen, so if someone uses an add-on that has only +1 healing or +1 regen (seems very unlikely), this scenario still counts it as +2
    # this logic ignores poison, so make sure that there's no chance for Konrad's units to get poisoned in this scenario
    #
    # reduced healing achieves a few things:
    #   1) we show that Asheviere's lava acutally did meaningful damage to Konrad's army
    #   2) we support Konrad's decision to ally with Li'sar, since his army really is badly weakened (in addition to his low gold)
    #   3) we prevent healers from being too powerful - they're usually strongest with small armies and long scenarios, like here
    #   4) we provide a different tactical challenge that's not seen elsewhere
    [event]
        name=side 1 turn
        first_time_only=no
        {MODIFY_UNIT side=1 status.unhealable yes}
    [/event]
    [event]
        name=side 1 turn refresh
        first_time_only=no
        {MODIFY_UNIT side=1 status.unhealable no}
        [heal_unit]
            [filter]
                side=1
                [and]
                    {FILTER_LOCATION terrain=*^V*}                           # heal if we're on a village
                    {OR({FILTER_ABILITY tag_name=regenerate})}               # heal if we can regenerate
                    {OR({FILTER_ADJACENT({FILTER_ABILITY tag_name=heals})})} # heal if we're adjacent to a healer
                [/and]
            [/filter]
            amount=2
        [/heal_unit]
    [/event]
    
    #############################
    # LISAR'S CAVE EXITS
    #############################
    [event]
        name=moveto
        [filter]
            side=1
            x=34,37
            y=3,4
        [/filter]
        [message]
            speaker=Konrad
            message=_"These must be the tunnels from whence Li’sar emerged. Out of all the countless exits from the underground, fate just so happened to bring us together here..."
        [/message]
        [allow_undo]
        [/allow_undo]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                FIGHTING ALONGSIDE LI'SAR
    #######################################################################################################################################################
    #############################
    # ALLY WITH LI'SAR
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_ADJACENT side=2} )}
        {FIRE_EVENT ally_with_lisar}
    [/event]
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=19,12,4} )}
        {FIRE_EVENT ally_with_lisar}
    [/event]
    [event]
        name=sighted
        {FILTER id=Iliah-Malal}
        {FILTER_SECOND side=1}
        {FIRE_EVENT ally_with_lisar}
    [/event]
    [event]
        name=ally_with_lisar
        #------------------------
        # DISCUSSING ALLIANCE
        #------------------------
        [message]
            speaker=Lisar
            message=_"Konrad! And with your army too, intact despite the volcano. Are you here to finish me off? I intend to have serious words with the queen if we somehow get out of this alive..."
        [/message]
        [message]
            speaker=Konrad
            message=_"I am not here to fight you, Li’sar — at least not right now. You are vulnerable, but so are we, and if we war the only winner will be the undead. I propose a truce."
        [/message]
        [message]
            speaker=Lisar
            message=_"A truce? What ploy is this; are you so cruel that you would give my men hope before snuffing it out? If you are come to slay me, hurry on and be done with it."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"There is no trick! Do not be a fool; surely you can see that if we do not stand together, we shall die alone? It is in both of our interests to work together."
        [/message]
        [message]
            speaker=Konrad {KONRAD_VARIATION mad}
            message=_"Do you agree to my proposal, princess? Or are we to fight and bleed and die until our bodies both are buried under crimson snow?"
        [/message]
        [message]
            speaker=Lisar
            message=_"..."
        [/message]
        [message]
            speaker=Lisar
            message=_"Very well, we shall work together for now. But do not forget that once these undead are defeated, you and I have a score to settle."
        [/message]
        [modify_side]
            side=2
            team_name=konrad
        [/modify_side]
        
        #------------------------
        # OBJECTIVES
        #------------------------
        [objectives]
            [objective]
                description= _ "Defeat all enemy leaders"
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
            {STARVING_NOTE}
        [/objectives]
        
        #############################
        # DISCUSS VOLCANO
        #############################
        [event]
            name=new turn
            [message]
                speaker=Lisar
                message=_"I should really have guessed that you and your rebels would have survived the volcano, Konrad. Luck never seems to come easy for mother and I."
            [/message]
            [message]
                speaker=Konrad
                message=_"Your mother just tried to have you killed! And still you defend her? Even now, when it should be clearer than ever that you’re nothing but a pawn."
            [/message]
            [message]
                speaker=Lisar
                message=_"Asheviere gave Mirya the orders she thought were necessary to prevent you from escaping. Whether they were wise orders or not is immaterial; she acted to ensure that Wesnoth survives, even if I don’t. I cannot fault her for that."
            [/message]
            [message]
                speaker=Konrad
                message=_"She acted to ensure her power remains unchallenged, you mean. You speak about the survival of Wesnoth, but Asheviere is its greatest threat, not I. The dark queen cares only for herself, and has already inflicted great harm upon her subjects."
            [/message]
            [message]
                speaker=Lisar
                message=_"“The dark queen,” pfft. I’ve heard enough slander; hold your tongue or I shall make an end to our truce and short work of you."
            [/message]
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     MEET ILIAH-MALAL
    #######################################################################################################################################################
    [event]
        name=sighted
        {FILTER id=Iliah-Malal}
        {FILTER_SECOND side=1}
        
        #############################
        # INTRODUCE MALAL
        #############################
        [message]
            speaker=Delfador
            message=_"A lich! So here is the source of the undead. Something about this magic feels familiar... very familiar..."
        [/message]
        [message]
            speaker=Iliah-Malal
            message=_"Ah ha ha, ha ha ha, so we meet again! You’re looking decrepit, Delfador, while I am strong and hale — perhaps you regret passing up the temptations of necromancy, so long ago?"
        [/message]
        [message]
            speaker=Delfador
            message=_"Iliah-Malal! A name most foul, and one that I have not spoken aloud in the many years since our battle. You should be dead; defiled, defeated and banished to whatever grim afterlife awaits the practitioner of your foul magic."
        [/message]
        [message]
            speaker=Iliah-Malal
            message=_"Dead I am, banished I am not! Lucky for me that Asheviere kept up her end of the bargain, and sent mages to cast the necromancy spells I left behind after my most untimely death at your hand."
        [/message]
        [message]
            speaker=Iliah-Malal
            message=_"Lucky for her, too, that she made my acquaintance, so I could guide her violent tendancies in a more... productive direction, and finally enact my revenge on the sons of Garard! Ah, a nasty piece of work, that Asheviere. Fate works in mysterious ways, no?"
        [/message]
        [message]
            speaker=Lisar {LISAR_VARIATION mad}
            message=_"I know my own mother, lich, and she would never be complicit in the raising of an abomination like yourself, nor is she overly-violent... except perhaps as a last resort. Why should I believe anything said by a lich?"
        [/message]
        [message]
            speaker=Iliah-Malal
            message=_"Mother? Ah ha ha ha, how sweet — the naive young princess springs forth to defend her senile queen. No, whatever caring facade she may put on in front of her daughter, I’ve worked with “Queen Asheviere” enough to know exactly who she is."
        [/message]
        [message]
            speaker=Iliah-Malal
            message=_"Your mother is one of the foulest human beings to ever walk the continent; ambitious, selfish, and violent; controlling and despotic. I can’t count how many times I had to stop her from sabotaging us both in retaliation for some perceived slight or challenge. Asheviere would gladly burn down the world if it meant she could rule over the embers, and surely only revived me because she thought I might still be of some use — killing you!"
        [/message]
        
        #############################
        # HELPER MACRO
        #############################
#define SPEECH_MULTIPART SNUM MESSAGE1A MESSAGE1B MESSAGE2
#arg SPEAKER
Konrad#endarg
        {VARIABLE message1a {MESSAGE1A}}
        {VARIABLE message1b {MESSAGE1B}}
        {VARIABLE message2  {MESSAGE2}}
        [if]
            {VARIABLE_CONDITIONAL status_{SNUM} equals completed}
            {HAVE_UNIT id={SPEAKER}}
        {THEN(
            [if]
                {VARIABLE_CONDITIONAL first_part_spoken not_equals yes}
                [then]
                    [if] {VARIABLE_CONDITIONAL message1a.length greater_than 0} {THEN(
                        [message]
                            speaker={SPEAKER}
                            message={MESSAGE1A}
                        [/message]
                    )} [/if]
                    [if] {VARIABLE_CONDITIONAL message1b.length greater_than 0} {THEN(
                        [message]
                            speaker=Lisar
                            message={MESSAGE1B}
                        [/message]
                    )} [/if]
                    {VARIABLE first_part_spoken yes}
                [/then]
                [elseif]
                    {VARIABLE_CONDITIONAL second_part_spoken not_equals yes}
                    {VARIABLE_CONDITIONAL message2.length greater_than 0}
                {THEN(
                    [message]
                        speaker={SPEAKER}
                        message={MESSAGE2}
                    [/message]
                    {VARIABLE second_part_spoken yes}
                )} [/elseif]
            [/if]
        )} [/if]
        {CLEAR_VARIABLE message1a,message1b,message2}
#enddef
        
        #############################
        # CUSTOM KONRAD MESSAGE
        #############################
        # take one segment of each SPEECH_MULTIPART to generate a 3-message interaction between Konrad and Li'sar, based on which scenarios the player chose
        # for example:
        #   K: You cannot deny, cousin, that Asheviere passed control of Elensefar to the orcish hordes when she found she could not bend the popluace to her will. It is only with my aid that the entire city was not enslaved!
        #   L: —no, I was told that the city was under the control of royal forces; the orcs were only supposed to aid in the attack. You can’t be right.
        #   K: Or what of how Asheviere allowed a necromancer to run amuck on the Peninsula of Pearls, to weaken and create chaos in the west? Without my intervention the entire coast might have been overrun!
        
        # Delwyn and Dallben
        # it's ok to leave the follow-up blank here on s08b, because since it's the FIRST speech in the list the follow-up will never get said
        [if] {HAVE_UNIT id=Harper} {THEN(
            {SPEECH_MULTIPART s08a
                _"You can’t deny, Li’sar, that th’ queen o’ yours was ready to massacre us smallfolk in Delwyn an’ Dallben jus’ because we refused to swear fealty. An’ she would’ve succeeded too, if we hadn’t fought back an’ fled an’ hid!"
                _"—no, that can’t be right. I was told that region had always been home to rebels, and that after the destruction of Halstead mother was regrettably forced to level the villages."
                ""
                SPEAKER=Harper
            }
        )} {ELSE(
            {SPEECH_MULTIPART s08a
                _"You cannot deny, cousin, that Asheviere was ready to massacre the smallfolk in Delwyn and Dallben just because they refused to swear fealty. They told me the story: had they not fought back and fled and hid, they would all be dead now."
                _"—no, that can’t be right. I was told that region had always been home to rebels, and that after the destruction of Halstead mother was regrettably forced to level the villages."
                ""
            }
        )} [/if]
        
        # Elensefar
        {SPEECH_MULTIPART s11
            _"You cannot deny, cousin, that Asheviere passed control of Elensefar to the orcish hordes when she found she could not bend the popluace to her will. I was there — it is only by my sword that the entire city was not enslaved!"
            _"—no, that can’t be right. I was told that the city was under the control of royal forces; the orcs were only supposed to aid in the attack."
            _"Or what of how Asheviere gave control of Elensefar to the orcish hordes when she found she could not bend the popluace to her will? Without my intervention the entire city would have been enslaved!"
        }
        
        # Muff Malal's Peninsula
        {SPEECH_MULTIPART s07
            _"You cannot deny, cousin, that Asheviere allowed a necromancer to run amuck on the Peninsula of Pearls, to weaken and create chaos in the west. I was there — it is only by my sword that Muff Malal was killed!"
            _"—no, that can’t be right. I was told that you rebels were the ones who invited the necromancer in, and that royal forces were beat back when they came to render aid."
            _"Or what of how Asheviere allowed a necromancer to run amuck on the Peninsula of Pearls, to weaken and create chaos in the west? Without my intervention the entire coast might have been overrun!"
        }
        
        # Bay of Pearls
        {SPEECH_MULTIPART s04
            _"You cannot deny, cousin, that Asheviere allowed her orcs to overrun the Bay of Pearls, to enslave the peaceful merfolk and force them to dive for her enrichment. I was there — it is only by my sword that they were freed!"
            _"—no, that can’t be right. I was told the orcs were protecting the merfolk against the rebels, not holding them as slavers."
            _"Or what of how Asheviere allowed her orcs to overrun the Bay of Pearls, to enslave the peaceful merfolk and force them to dive for her enrichment? Without my intervention they might never have been freed!"
        }
        
        # Flight of the Elves
        {SPEECH_MULTIPART s02
            _"You cannot deny, cousin, that after the elves’ defeat at the Aethenwood, Asheviere sent her armies to take the fleeing civilians as slaves. I was there — it is only by my sword that they escaped!"
            _"—no, that can’t be right. The Aethenwood elves are dangerous, hardly civilians, but they were to be afforded a fair trial and a just verdict, not taken as slaves."
            _"Or what of how after the elves’ defeat at the Aethenwood, Asheviere sent her armies to take the fleeing civilians as slaves? Without my intervention they be in chains in the mines!"
        }
        
        # Gryphon Mountain
        [if] {VARIABLE_CONDITIONAL bm_s14_fought_burlin equals yes} {THEN(
            {SPEECH_MULTIPART s14
                _"You cannot deny, cousin, that Asheviere sent her dwarvish lackies to slay Wesnoth’s wild gryphons and steal their eggs! I was there — it is only by my sword that Gryphon Mountain was not entirely ruined!"
                _"—no, that can’t be right. I was told we’d decided against the egg expedition, because of the intelligence of gryphons and the risks to their population."
                _"Or what of how Asheviere sent her dwarvish lackies to slay Wesnoth’s wild gryphons and steal their eggs? Without my intervention Gryphon Mountain might have been entirely ruined!"
            }
        )} {ELSE(
            {SPEECH_MULTIPART s14
                _"You cannot deny, cousin, that Asheviere sent her dwarvish lackies to slay Wesnoth’s wild gryphons and steal their eggs! I may have benefitted from the act, but that does not change Asheviere’s decision to do it."
                _"—no, that can’t be right. I was told we’d decided against the egg expedition, because of the intelligence of gryphons and the risks to their population."
                _"Or what of how Asheviere sent her dwarvish lackies to slay Wesnoth’s wild gryphons and steal their eggs? I may have benefitted from the act, but that does not change Asheviere’s decision to do it."
            }
        )} [/if]
        
        # Valley of Death
        {SPEECH_MULTIPART s15b
            _"You cannot deny, cousin, that Asheviere deliberately witheld aid from the Gryphon Mountain monastery, leaving many of their number to die at the hands of undead. It is only by my sword that their seal was restord and calamity averted!"
            _"—no, that can’t be right. The monastic mages are doing important work; it is the crown’s responsibility to keep them provisioned."
            _"Or what of how Asheviere deliberately witheld aid from the Gryphon Mountain monastery, leaving many of their number to die at the hands of undead? Without my intervention their seal would never have been restored!"
        }
        
        # Fallback: The Elves Besieged
        {SPEECH_MULTIPART s01
            _"You cannot deny, cousin, that Asheviere launched an unprovoked attack against the peaceful elves of the Aethenwood! She wanted to capture Delfador and me, yes, but I suspect she could also not stand the idea of a free and happy people living near her borders."
            _"—no, that can’t be right. The monastic mages are doing important work; it is the crown’s responsibility to keep them provisioned."
            _"Or what of how Asheviere launched an unprovoked attack against the peaceful elves of the Aethenwood? She wanted to capture Delfador and me, yes, but I suspect she could also not stand the idea of a free and happy people living near her borders."
        }
        
        {CLEAR_VARIABLE first_part_spoken,second_part_spoken}
        
        #############################
        # MALAL'S CLOSING REMARKS
        #############################
        {DELAY 250}
        [message]
            speaker=Iliah-Malal
            message=_"Ah ha ha, ha ha ha, poor little princess; what a wonderful expression that is on your face. Seeing your pain almost makes up for the emptiness of my undead existance. I’ve already got everything I wanted out of life; the deaths of Garard and Arand; my final revenge on Garard I the elder. With my own sons long-gone too, I have nothing left to fight for."
        [/message]
        [message]
            speaker=Iliah-Malal
            message=_"So come on then, fleshbag, give it your best shot. I can tell by your face that you desperately want to beat my skull in. Finish me off — if you can!"
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat Iliah-Malal"
                condition=win
            [/objective]
            {OBJECTIVES_HERODEATHS}
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
            {STARVING_NOTE}
        [/objectives]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # ILIAH MALAL DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Iliah-Malal}
        [message]
            speaker=Iliah-Malal
            message=_"Ah ha... ha ha ha..."
        [/message]
        [event]
            name=die
            {KILL_COUNT 5 side=3,4,5 ANIMATE=yes}
            {KILL side=3,4,5}
            
            #------------------------
            # ENDING THE TRUCE
            #------------------------
            [message]
                speaker=Konrad
                message=_"The lich is defeated, Li’sar, and our agreed-upon truce comes to an end. If we are to battle, know that even weakened from the caves you shall still find me a formidable foe."
            [/message]
            [message]
                speaker=Konrad
                message=_"But you heard my words about Asheviere, and Malal’s. The dark queen has already harmed countless lives, and will bring all that we love to ruin if we do not stop her. If you are willing, I would welcome your aid in my fight to make Wesnoth a better place."
            [/message]
            [message]
                speaker=Lisar
                message=_"My mother has her flaws, but the crimes of which you’ve accused her... I spent my entire childhood listening to my mother give orders and commanding armies around. I’d always given her the benefit of the doubt."
            [/message]
            [message]
                speaker=Lisar
                message=_"But I cannot deny there have been signs. I became my mother’s most trusted aide-de-camp. I was sent to quiet the worst of the various rebellions. Of course they fought back. I was never told who most of these people were or why they fought my mother. And her order in the volcano..."
            [/message]
            [message]
                speaker=Lisar
                message=_"Konrad, you are lucky. You do not know what Wesnoth has been like these past many years. There is no peace. I have never known peace."
            [/message]
            [message]
                speaker=Lisar
                message=_"..."
            [/message]
            
            #------------------------
            # JOINING TOGETHER
            #------------------------
            [message]
                speaker=Lisar
                message=_"I am willing to join you, cousin, even if it means opposing my own blood. Perhaps together we can save our home in a way that neither of us could alone."
            [/message]
            [message]
                speaker=Delfador
                message=_"I do know the cup of bitterness poured out on Wesnoth by your mother, child. The land has been torn apart. The elves know this. The orcs know this. Undead can feel it. Large armies of men march across the plains hunting each other, and when no men remain, outsiders will claim Wesnoth as their home."
            [/message]
            [message]
                speaker=Konrad
                message=_"Enough! I can listen to no more of this. Princess, you may want to end your mother’s rule, but I will end her life as she ended the life of my father and my brothers. Asheviere’s masterwork of treachery will end, and it will end by my blade! "
            [/message]
            {VARIABLE status_s30 completed}
            {VARIABLE status_s31 in_progress}
            [endlevel]
                result=victory
                {NEW_GOLD_CARRYOVER 40}
            [/endlevel]
        [/event]
    [/event]
    
    
    #############################
    # LISAR DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Lisar}
        [message]
            speaker=Lisar {LISAR_VARIATION defeat}
            message=_"I can’t believe it. Bested so far from home.... and in part by the actions of my own mother. Embarrassing..."
        [/message]
        [event]
            name=die
            {REPEAT 2 ({GENERIC_UNIT 5 "Soulless" 19 10} {ANIMATE})}
            {REPEAT 2 ({GENERIC_UNIT 5 "Soulless" 22 12} {ANIMATE})}
            {REPEAT 3 ({GENERIC_UNIT 5 "Soulless" 16 12} {ANIMATE})}
            {REPEAT 2 ({GENERIC_UNIT 5 "Soulless" 21 15} {ANIMATE})}
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"Li’sar has fallen, and her camps have become infested with undead! I would rejoice, if we were not surely about to follow her into undeath..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
    [/event]
    
    #############################
    # TIME OVER
    #############################
    [event]
        name=turn $({SCENARIO_TURN_LIMIT}-5)
        [message]
            speaker=Konrad
            message=_"Ugh... I am faint with hunger. It is possible Li’sar has some small amount of provisions, but she will surely not share them with an erstwhile enemy. We must finish these undead before we become too weak to fight!"
        [/message]
    [/event]
    [event]
        name=side 1 turn {SCENARIO_TURN_LIMIT} end
        [message]
            speaker=Konrad
            message=_"My heart... my head... hunger has taken a toll on us all. I can barely stand, much less fight, and the army is no better. Even if without our aid Li’sar is still able to vanquish these undead, she will surely do the same to us now that we have become so frail!"
        [/message]
    [/event]
[/scenario]

#undef SCENARIO_TURN_LIMIT
#undef STARVING_NOTE
#undef SPEECH_MULTIPART
