#textdomain wesnoth-h2tt
    
    
    
    
    
    
#define ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA KONRAD_OR_NOBODY
    [if] {VARIABLE_CONDITIONAL bm_fall_of_knalga_explained not_equals yes} {THEN(
        #------------------------
        # HAVE ULFDAIN
        #------------------------
        [if] {HAVE_UNIT( side,search_recall_list=1,yes {AND id=Ulfdain} )} {THEN(
            [cancel_action]
            [/cancel_action]
            {VARIABLE bm_fall_of_knalga_explained yes}
            {MOVE_UNDER_KONRAD( {RECALL_XY Ulfdain $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=Ulfdain "$($stored_konrad.x-1)" $stored_konrad.y} )}
            [message]
                speaker={KONRAD_OR_NOBODY}
                message=_"What happened here was such a tragedy... do you know anything more than I, Ulfdain?"
            [/message]
            [message]
                speaker=Ulfdain
                message=_"Aye... ’twas a time of doom an’ great deeds, o’ fire an’ blood an’ slaughter. My father an’ his father alike perished defendin’ th’ west gate, an’ soon after fell the Doors, an’ our king Thunedain with them."
            [/message]
            [message]
                speaker=Ulfdain
                message=_"The better part o’ our spirit died in those years. E’er since, us dwarves’ve been a people in decline, sniveling in our tunnels, th’ dyin’ dregs of a once-proud people. Or betrayin’ their kin to start anew in human lands, like me..."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION concerned}
                message=_"I’ve never-before heard you speak so grimly, Ulfdain. I’m sorry for your loss. Is there nothing we can do to restore Knalga to its former glory?"
            [/message]
            [message]
                speaker=Ulfdain
                message=_"Not lest ye’ can fight off all the orcs o’ the north, an’ trolls an’ undead besides. No, there ain’t no use cryin’ over it. Ah’ve given up hope; it’s only death in battle tha’ I wish fer now..."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Ulfdain $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Ulfdain} )}
        )}
        #------------------------
        # HAVE DWARF
        #------------------------
        [elseif] {HAVE_UNIT( side,search_recall_list=1,yes {AND race=dwarf,gryphon} )} {THEN(
            [cancel_action]
            [/cancel_action]
            {VARIABLE bm_fall_of_knalga_explained yes}
            {STORE_UNIT_VAR ( side,x,y=1,recall,recall {AND race=dwarf,gryphon} ) id dwarf_id}
            {MOVE_UNDER_KONRAD( {RECALL_XY $dwarf_id $stored_konrad.x $stored_konrad.y} {MOVE_UNIT id=$dwarf_id "$($stored_konrad.x-1)" $stored_konrad.y} )}
            [message]
                speaker={KONRAD_OR_NOBODY}
                message=_"What happened here was such a tragedy... is there nothing we can do to restore Knalga to its former glory? Do you know anything more than I, my dwarvish friend?"
            [/message]
            [message]
                speaker=$dwarf_id
                message=_"Aye, but ’tis not a time we dwarves like to talk about. The west gate fallen, the Dwarven Doors sacked..."
            [/message]
            [message]
                speaker=$dwarf_id
                message=_"No, there ain’t nothin’ ye can do, not unless ye’ can fight off all the orcs o’ the north, an’ trolls an’ undead besides. Us dwarves’re doomed to be a people in decline, sniveling in our tunnels, th’ dyin’ dregs of a once-proud people..."
            [/message]
            {MOVE_UNDER_KONRAD( {MOVE_UNIT id=$dwarf_id $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=$dwarf_id} )}
            {CLEAR_VARIABLE dwarf_id}
        )} [/elseif]
        #------------------------
        # NO DWARVES
        #------------------------
        {ELSE(
            # say nothing. Don't set bm_fall_of_knalga_explained until we have dwarf who can explain this
        )} [/if]
    )} [/if]
#enddef
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                              S26 - THE DWARVEN DOORS
    #######################################################################################################################################################
#define S26_PRESTART
    #------------------------
    # ORCS
    #------------------------
    {GENERIC_UNIT 10 "Orcish Warrior"     47 17} {FACING se} {LEADER}
    {GENERIC_UNIT 10 "Orcish Crossbowman" 50 16} {FACING sw} {LEADER}
    {GENERIC_UNIT 10 "Orcish Warrior"     50 18} {FACING sw} {LEADER}
    {GENERIC_UNIT 10 "Orcish Grunt"       48 17} {FACING ne}
    {GENERIC_UNIT 10 "Orcish Grunt"       53 19} {FACING ne}
    {GENERIC_UNIT 10 "Orcish Archer"      52 19} {FACING se}
    {GENERIC_UNIT 10 "Wolf Rider"         54 20} {FACING se}
    {GENERIC_UNIT 10 "Orcish Grunt"       45 19} {FACING ne}
    {GENERIC_UNIT 10 "Orcish Grunt"       47 21} {FACING se}
    {GENERIC_UNIT 10 "Orcish Archer"      46 20} {FACING sw} {ROLE doors_orc}
    
    #------------------------
    # SLAVES
    #------------------------
    {GENERIC_UNIT 5 "Peasant"  47 19} {FACING sw}
    {GENERIC_UNIT 5 "Peasant"  48 19} {FACING se}
    {GENERIC_UNIT 5 "Woodsman" 47 20} {FACING sw} {ROLE doors_woodsman}
    {GENERIC_UNIT 5 "Peasant"  49 20} {FACING se}
    {GENERIC_UNIT 5 "Peasant"  52 20} {FACING se} # 52,21 is used by the lisar-approaches-sceptre event
    {GENERIC_UNIT 5 "Peasant"  51 20} {FACING se}
    {GENERIC_UNIT 5 "Woodsman" 44 20} {FACING se}
#enddef
    [event] name=prestart {SET_LABEL 48 18 _"Dwarven Doors"} [/event]
    {PLACE_POI 49 19 s26 # if I change snum, also change the secondary POI's fire_event
        SCENARIO_FILE=26_The_Dwarven_Doors
        (PREVIEW_WML=
            title=_"The Dwarven Doors"
            difficulty,gold=2,2
            recruit1=units/human-peasants/peasant.png
            recruit2=units/human-peasants/woodsman.png
        )
        #############################
        # INCOMPLETE
        #############################
        (INCOMPLETE_PRESTART=
            {S26_PRESTART}
            
            #------------------------
            # SECONDARY POIS
            #------------------------
            {REMOVE_IMAGE 49 19}
            
            # southeast
            {PLACE_IMAGE bigmap/poi-battle.png 48 16}
            [event]
                name,first_time_only=enter hex,no
                {FILTER id,x,y=Konrad,48,16}
                {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
                {FIRE_EVENT_UNIT preview_poi_s26 id=$unit.id}
            [/event]
            
            # southwest
            {PLACE_IMAGE bigmap/poi-battle.png 50 20}
            [event]
                name,first_time_only=enter hex,no
                {FILTER id,x,y=Konrad,50,20}
                {VARIABLE s10_from_west yes}
                {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
                {FIRE_EVENT_UNIT preview_poi_s26 id=$unit.id}
            [/event]
        )
        (INCOMPLETE_APPROACHED=
            # nothing. Handle "approach" manually, so we can properly explain the fall of knalga
        )
        (INCOMPLETE_MOVETO=
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"The once-thriving free city of Dwarven Doors is filled with slaves and their orcish masters. If we wish to fight our way through, we must free as many slaves as possible on our way!"
            [/message]
            [if] {VARIABLE_CONDITIONAL previous_y less_than 18}
                {THEN( {VARIABLE s26_from n} )}
                {ELSE( {VARIABLE s26_from s} )}
            [/if]
        )
        
        #############################
        # COMPLETED
        #############################
        (COMPLETED_PRESTART=
            [if] {VARIABLE_CONDITIONAL bm_s26_total_victory equals yes} {THEN(
                # nobody; orcs are all dead and slaves are all rescued
            )} {ELSE(
                {S26_PRESTART}
            )} [/if]
        )
        (JUSTCOMPLETED_START=
            [if] {VARIABLE_CONDITIONAL s26_from equals n} {THEN(
                {MOVE_UNIT id=Konrad 47 15}
            )} {ELSE(
                {MOVE_UNIT id=Konrad 49 22}
            )} [/if]
            {CLEAR_VARIABLE s26_from}
            
            [if] {VARIABLE_CONDITIONAL bm_s26_total_victory equals yes} {THEN(
                [message]
                    speaker=Konrad
                    message=_"We have cleared the Doors of orcs! It sounds as though they mean to return in the future, but at least for now we will be able to pass unmolested."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Konrad
                    message=_"We have fought our way through the Doors! The orcs know better than to try and fight us again in the future, but neither can we get at amy more of their slaves while they are on such alert. At least we will henceforth be able to pass unmolested."
                [/message]
            )} [/if]
            {FIRE_EVENT check_for_knalgan_resurgence}
        )
        (COMPLETED_MOVETO=
        )
    }
    #############################
    # CUSTOM APPROACH EVENT
    #############################
    [event]
        name=enter hex
        {FILTER( side=1 {FILTER_LOCATION( x,y,radius=49,19,4 )} )}
        # repeat this "approach" event every single time we load the bigmap. Handle which specific dialogues to say (if any) in special detail
        
        # the first time, play regular approach dialogue
        [if] {VARIABLE_CONDITIONAL approached_s28_initial not_equals yes} {THEN(
            [cancel_action]
            [/cancel_action]
            {VARIABLE approached_s26_initial yes}
            {DELAY 250}
            {ANIMATE_HARM role=doors_orc 4 range=melee role=doors_woodsman}
            [message]
                role=doors_orc
                message=_"Get back to work, pinkskin! Show your masters a proper work ethic and maybe you’ll be spared the lash!"
            [/message]
            {DELAY 250}
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"Slaves? This is a travesty! Weren’t the Dwarven Doors once a great center of civilization?"
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"Their alliance with Knalga was strong, but even man and dwarf together could not stop the orcish war-horde. And now it’s a slave city under the heel of the orcs!"
            [/message]
            {ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA nobody}
        )}
        # for future times, only try to explain the fall of knalga
        {ELSE(
            {ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA Konrad}
        )} [/if]
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                S28 - THE LOST GENERAL
    #######################################################################################################################################################
    [event] name=prestart {SET_LABEL 40 12 _"Caverns of Chaincolt"} [/event]
    {PLACE_POI 39 12 s28
        SCENARIO_FILE=28_The_Lost_General
        (PREVIEW_WML=
            title=_"The Lost General"
            preview=bigmap/preview-shroud.png
            difficulty,gold=2,2
            otherlabel=_"Weapon for Konrad: <span color='#EFBF04'><b>+2 melee damage, <i>drains</i> special on melee attacks</b></span>"
        )
        #############################
        # INCOMPLETE
        #############################
        (INCOMPLETE_PRESTART=
            # place a skeleton so that the player knows there's undead here, and brings anti-undead units
            {GENERIC_UNIT 6 Revenant 40 11} {FACING se} {HITPOINTS 35} # wesred, because it's one of Lionel's troops
            # place trolls to block off entrances, so that there's 3 distinct passageways (matching the in-scenario map)
            {GENERIC_UNIT 8 "Troll"       39 13} {FACING sw} {HITPOINTS 15}
            {GENERIC_UNIT 8 "Troll Whelp" 41 12} {FACING nw}
            {GENERIC_UNIT 8 "Troll Whelp" 37 13} {FACING sw}
        )
        (INCOMPLETE_APPROACHED=
            # nothing. Handle "approach" manually, so we can properly explain the fall of knalga
        )
        (INCOMPLETE_MOVETO=
            [message]
                speaker=Konrad
                message=_"These old halls were ruined long ago, but there may still be something of value inside."
            [/message]
            [if] {VARIABLE_CONDITIONAL previous_x equals 39} {THEN( {VARIABLE s28_from nw} )}[/if] # determine where Konrad spawns on the scenario map
            [if] {VARIABLE_CONDITIONAL previous_x equals 38} {THEN( {VARIABLE s28_from sw} )}[/if]
            [if] {VARIABLE_CONDITIONAL previous_x equals 40} {THEN( {VARIABLE s28_from se} )}[/if]
        )
        
        #############################
        # COMPLETED
        #############################
        (COMPLETED_PRESTART=
            {CLEAR_VARIABLE s28_from}
        )
        (JUSTCOMPLETED_START=
            [message]
                speaker=Konrad
                message=_"I’m glad to be out into the sun and fresh air again. I’m don’t despise caves so much as an elf, but I’m no dwarf either."
            [/message]
            {FIRE_EVENT check_for_knalgan_resurgence}
        )
        (COMPLETED_MOVETO=
            [message]
                speaker=Konrad
                message=_"There’s nothing more of value here — at least nothing that we have the time or skill to unearth."
            [/message]
        )
    }
    #############################
    # CUSTOM APPROACH EVENT
    #############################
    [event]
        name=enter hex
        {FILTER( side=1 {FILTER_LOCATION( x,y,radius=39,13,4 )} )}
        # repeat this "approach" event every single time we load the bigmap. Handle which specific dialogues to say (if any) in special detail
        
        # the first time, play regular approach dialogue
        [if] {VARIABLE_CONDITIONAL approached_s28_initial not_equals yes} {THEN(
            [cancel_action]
            [/cancel_action]
            {VARIABLE approached_s28_initial yes}
            [message]
                speaker=Konrad
                message=_"The west gates of Knalga! I learned about this place... it was a terrible tragedy when the kingdom of the dwarves was shattered by the orcs and their allies. Now all that’s left here are trolls and ruins."
            [/message]
            {ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA nobody}
        )}
        # for future times, only try to explain the fall of knalga
        {ELSE(
            {ATTEPT_TO_EXPLAIN_FALL_OF_KNALGA Konrad}
        )} [/if]
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                S29 - EAST KNALGA
    #######################################################################################################################################################
#define S29_PRESTART
    {SET_LABEL 49 13 _"Greater Knalga"}
    {PLACE_IMAGE "items/bones.png"      38 12}
    {PLACE_IMAGE "items/bones.png~FL()" 45 13}
    {PLACE_IMAGE "items/bones.png"      41 14}
    
    {NAMED_UNIT   5 "Dwarvish Stalwart"    50 12 Geldar  _"Geldar"  ()} {FACING sw} {HITPOINTS 45}
    {NAMED_UNIT   5 "Dwarvish Lord"        53 12 Relgorn _"Relgorn" ()} {FACING sw} {LEADER}
    {GENERIC_UNIT 5 "Dwarvish Dragonguard" 55 13} {FACING ne}
    {GENERIC_UNIT 5 "Dwarvish Guardsman"   56 11} {FACING ne}
#enddef
    {PLACE_POI 51 12 s29
        APPROACH_RADIUS=2
        SCENARIO_FILE=29_East_Knalga
        (PREVIEW_WML=
            title=_"Digging for Dwarves"
            preview=bigmap/preview-shroud.png
            difficulty,gold=1,0
            recruitlabel=_"New Recruits
Choose Two:"
            recruit1=units/dwarves/fighter.png
            recruit2=units/dwarves/guard.png
            recruit3=units/dwarves/thunderer/thunderer.png
            recruit4=units/dwarves/ulfserker.png
        )
        #############################
        # INCOMPLETE
        #############################
        (INCOMPLETE_PRESTART=
            {S29_PRESTART}
            
            # moved POI; the actual POI is in impassable mountains, so that the approach radius works correctly
            {REMOVE_IMAGE 51 12}
            {PLACE_IMAGE bigmap/poi-battle.png 52 12}
            [event]
                name,first_time_only=enter hex,no
                {FILTER id,x,y=Konrad,52,12}
                {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
                {FIRE_EVENT_UNIT preview_poi_s29 id=$unit.id}
            [/event]
        )
        (INCOMPLETE_APPROACHED=
            #------------------------
            # KNALGANS ARE SUSPICIOUS
            #------------------------
            [if] {VARIABLE_CONDITIONAL bm_s29_dwarves_suspicious equals yes} {THEN(
                [message]
                    speaker=Geldar
                    message=_"What now, human? I already told ye, no-one gets in without someone to vouch for ’em."
                [/message]
            )} {ELSE(
                [message]
                    speaker=Geldar
                    message=_"Another attack! Up axes, and make ready to repel the invaders!"
                [/message]
                [message]
                    speaker=Konrad
                    message=_"Peace, dwarves of Knalga! I am a man of Wesnoth, not an orc or a troll, and I come as a friend."
                [/message]
                [message]
                    speaker=Geldar
                    message=_"A man? Haven’t seen many o’ yer kind since our friends at the Doors fell, an’ you ain’t one o’ their’s. Who says we should trust ye?"
                [/message]
            )} [/if]
            
            #------------------------
            # VOUCH FOR KONRAD
            #------------------------
            # Ulfdain
            [if] {HAVE_UNIT id,side,search_recall_list=Ulfdain,1,yes} {THEN(
                {MOVE_UNDER_KONRAD(
                    {RECALL_XY Ulfdain $stored_konrad.x $stored_konrad.y}
                    {MOVE_UNIT id=Ulfdain "$($stored_konrad.x-1)" $stored_konrad.y}
                    {MODIFY_UNIT id=Ulfdain facing se}
                )}
                [message]
                    speaker=Ulfdain
                    message=_"Let us in, ye chicken-hearted cad! Cannae a dwarf return to ’is home without bein’ set upon like some horde o’ trolls?"
                [/message]
                [message]
                    speaker=Geldar
                    message=_"I dunno..."
                [/message]
                [if] {HAVE_UNIT id,type=Ulfdain,"Dwarvish Bloodaxe"} {THEN(
                    [message]
                        speaker=Relgorn
                        message=_"Ulfdain!? Can it really be you— an’ yer a Bloodaxe now too! Get across th’ bridge then, quickly-now, afore th’ orcs find ye."
                    [/message]
                )} {ELSE(
                    [message]
                        speaker=Relgorn
                        message=_"Ulfdain!? Can it really be you? Get across th’ bridge then, quickly-now, afore th’ orcs find ye."
                    [/message]
                )} [/if]
                {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Ulfdain $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Ulfdain} )}
            )}
            
            # Uncle Somf
            [elseif] {HAVE_UNIT id,side,search_recall_list=Somf,1,yes} {THEN(
                {MOVE_UNDER_KONRAD(
                    {RECALL_XY Somf $stored_konrad.x $stored_konrad.y}
                    {MOVE_UNIT id=Somf "$($stored_konrad.x-1)" $stored_konrad.y}
                    {MODIFY_UNIT id=Somf facing se}
                )}
                [message]
                    speaker=Somf
                    message=_"I’m from the Doors, your old human allies! And I’m free now, thanks to this boy Konrad and his army! They’re good people, and I’ll vouch for ’em."
                [/message]
                [message]
                    speaker=Geldar
                    message=_"I dunno..."
                [/message]
                [message]
                    speaker=Relgorn
                    message=_"Ah, let ’em in, Geldar. They ’aint orcs, trolls, or undead, an’ that’s good enough for now."
                [/message]
                {MOVE_UNDER_KONRAD( {MOVE_UNIT id=Somf $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Somf} )}
            )}[/elseif]
            
            # Dwarven Doors peasant
            [elseif] {VARIABLE_CONDITIONAL status_s26 equals completed} {THEN(
                {MOVE_UNDER_KONRAD(
                    {GENERIC_UNIT 1 Peasant $stored_konrad.x $stored_konrad.y} {ROLE doors_vouch_peasant}
                    {MOVE_UNIT role=doors_vouch_peasant "$($stored_konrad.x-1)" $stored_konrad.y}
                    {MODIFY_UNIT role=doors_vouch_peasant facing se}
                )}
                [message]
                    role=doors_vouch_peasant
                    message=_"I’m from the Doors, your old human allies! And I’m free now, thanks to this boy Konrad and his army! They’re good people, and I’ll vouch for ’em."
                [/message]
                [message]
                    speaker=Geldar
                    message=_"I dunno..."
                [/message]
                [message]
                    speaker=Relgorn
                    message=_"Ah, let ’em in, Geldar. They ’aint orcs, trolls, or undead, an’ that’s good enough for me."
                [/message]
                {MOVE_UNDER_KONRAD( {MOVE_UNIT id=doors_vouch_peasant $stored_konrad.x $stored_konrad.y} {KILL role=doors_vouch_peasant} )}
            )}[/elseif]
            
            # generic dwarf
            [elseif] {HAVE_UNIT race,side,search_recall_list=dwarf,1,yes} {THEN(
                {MOVE_UNDER_KONRAD(
                    [recall]
                        race,side=dwarf,1
                        x,y=$stored_konrad.x,$stored_konrad.y
                    [/recall]
                    {MODIFY_UNIT x,y=$stored_konrad.x,$stored_konrad.y role doors_vouch_dwarf}
                    {MOVE_UNIT role=doors_vouch_dwarf "$($stored_konrad.x-1)" $stored_konrad.y}
                    {MODIFY_UNIT role=doors_vouch_dwarf facing se}
                )}
                [message]
                    role=doors_vouch_peasant
                    message=_"Ah’m a dwarf, gatekeeper, an’ I’ll vouch for them. Lower yer axes an’ let us in, ye hear?"
                [/message]
                [message]
                    speaker=Geldar
                    message=_"I dunno..."
                [/message]
                [message]
                    speaker=Relgorn
                    message=_"Ah, let ’em in, Geldar. They ’aint orcs, trolls, or undead, an’ that’s good enough for me."
                [/message]
                {MOVE_UNDER_KONRAD( {MOVE_UNIT id=doors_vouch_dwarf $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST role=doors_vouch_dwarf} )}
            )}[/elseif]
            
            # nobody to vouch for Konrad
            {ELSE(
                [if] {VARIABLE_CONDITIONAL bm_s29_dwarves_suspicious equals yes} {THEN(
                    # say nothing; we already spoke about this
                )} {ELSE(
                    [message]
                        speaker=Konrad
                        message=_"I am the prince Konrad, nephew of Garard, son of Arand and heir to Wesnoth! I give my word — you can trust me, dwarf."
                    [/message]
                    [message]
                        speaker=Geldar
                        message=_"Hmph. So you say. We’ve had pretenders workin’ for th’ orcs try an’ sneak in here before. Even if you really are a prince, you ain’t gettin’ ’cross the east bridge lest ye’ve got someone to vouch for ye."
                    [/message]
                )} [/if]
                {MOVE_UNIT id=Konrad $previous_x $previous_y}
                {VARIABLE bm_s29_dwarves_suspicious yes}
                {CLEAR_VARIABLE approached_s29}
                [return]
                [/return]
            )} [/if]
            
            #------------------------
            # EXPLAINING THE SCENARIO
            #------------------------
            {MOVE_UNIT id=Konrad 52 12}
            [message]
                speaker=Relgorn
                message=_"What brings you to th’ East Gate o’ Knalga, friends? You be wantin’ somethin’ from us, don’t you?"
            [/message]
            [message]
                speaker=Konrad
                message=_"Well, to be honest, people usually want something from <i><b>me</b></i> instead. I help out with a problem someone is having, and then they send some spare fighters to join my army. Can you and I arrange anything like that?"
            [/message]
            [message]
                speaker=Geldar
                message=_"Spare fighters? I ain’t heard a jest that good since th’ trolls got Durrasil! Yer walkin’ through the corpse o’ our empire, fallen to rot an’ ruin, an’ ye got the gall to ask if we have extra axe-arms to send out with ye?"
            [/message]
            [message]
                speaker=Relgorn
                message=_"I’m afraid Geldar’s right. But problems — now problems we’ve got plenty of. Orc attacks, troll attacks, undead attacks. ’an now down in th’ mines—"
            [/message]
            [message]
                speaker=Geldar
                message=_"Relgorn, hush. That ain’t somethin’ fer outsiders to hear about."
            [/message]
            [message]
                speaker=Relgorn
                message=_"Do ye got a better idea? We already tried t’ split ourselves up an’ help, an’ tha’s when trolls took the gatehouse!"
            [/message]
            {DELAY 250}
            [message]
                speaker=Relgorn
                message=_"Listen, human... I’m only trustin’ you ’cause you been vouched for, unnerstand? All ye need to know is that some o’ our people’re trapped in a cave-in down in th’ old mines. You get ’em out, we’ll make it worth yer while."
            [/message]
            {VARIABLE skip_moveto_dialogue yes}
            {VARIABLE previous_x $x2}{VARIABLE previous_y $y2}
            {FIRE_EVENT_UNIT preview_poi_s29 id=$unit.id}
            {CLEAR_VARIABLE skip_moveto_dialogue}
        )
        (INCOMPLETE_MOVETO=
            [if] {VARIABLE_CONDITIONAL skip_moveto_dialogue not_equals yes} {THEN(
                [message]
                    speaker=Relgorn
                    message=_"Some o’ our people’re trapped in a cave-in down in th’ old mines. Tha’s all ye need to know. You get ’em out, an’ we’ll make it worth yer while."
                [/message]
            )} [/if]
        )
        
        #############################
        # COMPLETED
        #############################
        (COMPLETED_PRESTART=
            {S29_PRESTART}
        )
        (JUSTCOMPLETED_START=
            {TELEPORT_UNIT id=Konrad 52 12} # this also fires the moveto
            {FIRE_EVENT check_for_knalgan_resurgence}
        )
        (COMPLETED_MOVETO=
            [message]
                speaker=Ragaril
                message=_"Thank ye again, Konrad. May ye have better luck saving your home than we’ve had for ours."
            [/message]
        )
    }
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                  KNALGAN RESURGENCE
    #######################################################################################################################################################
#define RESURGENCE_UNITS WML
    {GENERIC_UNIT 5 "Dwarvish Fighter"      40 11} {FACING se} {WML}
    {GENERIC_UNIT 5 "Dwarvish Fighter"      42 12} {FACING sw} {WML}
    {GENERIC_UNIT 5 "Dwarvish Thunderguard" 47 13} {FACING nw} {WML}
    {GENERIC_UNIT 5 "Dwarvish Guardsman"    48 15} {FACING sw} {WML}
    {GENERIC_UNIT 5 "Dwarvish Fighter"      45 15} {FACING se} {WML}
#enddef
    #############################
    # TRIGGER RESURGENCE
    #############################
    [event]
        name=check_for_knalgan_resurgence
        [filter_condition]
            {VARIABLE_CONDITIONAL s26_status equals completed}
            {VARIABLE_CONDITIONAL s28_status equals completed}
            {VARIABLE_CONDITIONAL s29_status equals completed}
            {VARIABLE_CONDITIONAL bm_s26_total_victory   equals yes}
            {VARIABLE_CONDITIONAL bm_s29_refused_payment equals yes}
            {VARIABLE_CONDITIONAL bm_knalgans_resurged not_equals yes}
        [/filter_condition]
        
        {STORE_UNIT_VAR id=Relgorn x relgornX}
        {STORE_UNIT_VAR id=Relgorn y relgornY}
        {DO_AT_COORDS id=Konrad ({MOVE_UNIT id=Relgorn $coordX $coordY})}
        [message]
            speaker=Relgorn
            message=_"What’s this? Konrad, ye’ve chased the orcs out o’ the Doors, wiped out th’ trolls an’ undead squattin’ in our halls, and e’en trustworthily helped us in the heart o’ Knalga itself."
        [/message]
        [message]
            speaker=Relgorn
            message=_"I know that the troll’ll return. I know that the orcs’ll return, an’ that many o’ the Doors-folk are still with ’em, enslaved. But ye’ve given us dwarves more breathin’ room than we’ve had in many a year."
        [/message]
        {RESURGENCE_UNITS {ANIMATE}}
        [message]
            speaker=Relgorn
            message=_"I know ye said ye dinnae want any reward fer helpin’ us, but yer gettin’ one anyway. I’m sendin’ the best lads in Knalga to help you fight that queen o’ yers."
        [/message]
        {NEW_RECRUIT4
            (Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Thunderer,Dwarvish Ulfserker)
            _"You can now recruit Dwarvish Fighters, Guardsmen, Thunderers, and Ulfserkers!"
            dwarves/fighter.png dwarves/guard.png dwarves/thunderer/thunderer.png dwarves/ulfserker.png
        }
        {MOVE_UNIT id=Relgorn $relgornX $relgornY}
        {CLEAR_VARIABLE relgornX,relgornY}
        
        {VARIABLE bm_knalgans_resurged yes}
    [/event]
    #############################
    # RESURGENCE PRESTART
    #############################
    [event]
        name=prestart
        {FILTER_CONDITION({VARIABLE_CONDITIONAL bm_knalgans_resurged equals yes})}
        {RESURGENCE_UNITS ()}
    [/event]
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   S30 - SCEPTRE OF FIRE
    #######################################################################################################################################################
#define DELFADOR_AT_SCEPTRE
    {LUA(<<return wesnoth.current.turn>=(wml.variables['bm_milestone_elensefar'])>>)}
    {OR({VARIABLE_CONDITIONAL status_s10 equals completed  })}
    {OR({VARIABLE_CONDITIONAL status_s10 equals in_progress})}
#enddef
    #############################
    # BEFORE_POI
    #############################
    [event]
        name=prestart
        {FILTER_CONDITION({NOT( {DELFADOR_AT_SCEPTRE} )})}
        [event]
            name,first_time_only=moveto,no
            {FILTER id,x,y=Konrad,54-55,14-16}
            [message]
                speaker=Konrad
                message= _ "There are countless caves and lava tunnels here, twisting and turning for miles on end. There’s no reason to wander any deeper this way, at least not right now."
            [/message]
        [/event]
    [/event]
    
    #############################
    # EXPLAIN SCEPTRE MACRO
    #############################
#define EXPLAIN_SCEPTRE BEFORE_OR_DURING
    [message]
        speaker=Delfador
        message=_"The Sceptre is quite real, I assure you. Perhaps you have forgotten our lessons..."
    [/message]
    {FADE_MUSIC_OUT 500}
    {REPLACE_SCENARIO_MUSIC decoherence.ogg} # same music that plays during TDG "The Sylvan Seer"
    {FADE_MUSIC_IN 0}
    [hide_unit]{NOT id=Konrad,Delfador,Kalenz}[/hide_unit]
    {FADE_TO_BLACK}
    [message]
        speaker=Delfador {DELFADOR_VARIATION mentoring}
        message=_"The Ruby— now Sceptre of Fire is the symbol of the kings of Wesnoth, forged by the dwarves of Knalga at the behest of King Haldric II. It took their finest smiths years to make it, but soon after it was completed, the makers were chased underground, attacked by the elves."
    [/message]
    [message]
        speaker=Delfador {DELFADOR_VARIATION mentoring}
        message=_"None know exactly what occurred, but the Sceptre was lost somewhere in the great caverns. Years have passed, and the fortunes of the dwarves have waxed and waned, but the Sceptre has never been found."
    [/message]
    {VARIABLE bm_sceptre_explained_when {BEFORE_OR_DURING}}
    [if] {VARIABLE_CONDITIONAL bm_sceptre_explained_when equals before} {THEN([message]
        speaker=Kalenz
        message=_"Until now. The strands of prophecy are moving, Konrad — it has been foretold that if your mentor searches for the Sceptre here, his magic is sure to find it."
    [/message])} {ELSE([message]
        speaker=Kalenz
        message=_"Until now. The strands of prophecy are moving, Konrad — it was foretold that if your mentor searched for the Sceptre here, his magic would be sure to find it. And he has."
    [/message])} [/if]
    [message]
        speaker=Kalenz
        message=_"And though I know not how nor exactly why, it has similarly been revealed that you must someday hold the Sceptre if peace is ever to find Wesnoth ...or the elves."
    [/message]
    {FADE_IN}
    [unhide_unit]{NOT id=Konrad,Delfador,Kalenz}[/unhide_unit]
    {FADE_MUSIC_OUT 700}
    {REPLACE_SCENARIO_MUSIC wanderer.ogg}
    {FADE_MUSIC_IN 0}
    
    #------------------------
    # KONRAD GETS COCKY
    #------------------------
    [if] {VARIABLE_CONDITIONAL bm_sceptre_explained_when equals before} {THEN([message]
        speaker=Konrad {KONRAD_VARIATION mad}
        message=_"Well, all right then. What’re we waiting for? Let’s scour these caverns, get the Sceptre, and reclaim the kingdom! If there’s augury about it we’re guaranteed to succeed, right?"
    [/message])} {ELSE([message]
        speaker=Konrad {KONRAD_VARIATION mad}
        message=_"Well, all right then. What’re we waiting for? Let’s get the Sceptre and reclaim the kingdom! If there’s augury about it we’re guaranteed to succeed, right?"
    [/message])} [/if]
    [message]
        speaker=Delfador
        message=_"No, no, no! This is <b><i>precisely</i></b> what I was worried about. You are not guaranteed to succeed, nor are you invincible!"
    [/message]
    [message]
        speaker=Delfador
        message=_"When I was young I found myself in a similar situation. Through my arrogance and my haste, I ruined quite nearly everything. You already know the story of my folly."
    [/message]
    [message]
        speaker=Konrad
        message=_"My father, Prince Arand."
    [/message]
    [if] {VARIABLE_CONDITIONAL bm_sceptre_explained_when equals before} {THEN([message]
        speaker=Delfador
        message=_"Quite right. Do not become overconfident, Konrad. I am searching for the Sceptre now. Once it is found, I promise you shall most certainly have it."
    [/message])} {ELSE([message]
        speaker=Delfador
        message=_"Quite right. Do not become overconfident, Konrad. We may be about to claim the Sceptre, but we have not done so yet. And you are not yet king."
    [/message])} [/if]
    [message]
        speaker=Delfador
        message=_"But no matter what, please — be forgiving, be wise, and above all be kind. For that is where I failed."
    [/message]
    {MOVE_UNDER_KONRAD({MOVE_UNIT id=Kalenz $stored_konrad.x $stored_konrad.y} {PUT_TO_RECALL_LIST id=Kalenz})}
#enddef
    #############################
    # POI
    #############################
    {PLACE_POI 55 15 s30
        APPROACH_RADIUS=2
        CONDITION={DELFADOR_AT_SCEPTRE}
        SCENARIO_FILE=30_The_Sceptre_of_Fire
        (PREVIEW_WML=
            title=_"The Sceptre of Fire"
            preview=bigmap/preview-shroud.png
            difficulty,gold=3,0
            otherlabel=_"Weapon for Konrad: <span color='#EFBF04'><b>the Sceptre of Fire</b></span>"
        )
        (INCOMPLETE_PRESTART=
            {UNSTORE_NPC Delfador x,y=56,15 side,facing=3,se}
            {GIVE_OBJECT_TO id=Delfador id=dont_levitate}
        )
        #############################
        # APPROACH
        #############################
        (INCOMPLETE_APPROACHED=
            {MOVE_UNDER_KONRAD(
                {RECALL_XY Kalenz $stored_konrad.x $stored_konrad.y}
                {MOVE_UNIT id=Kalenz "$($stored_konrad.x-1)" $stored_konrad.y}
                {MODIFY_UNIT id=Kalenz facing se}
            )}
            {MODIFY_UNIT id=Delfador facing sw}
            #------------------------
            # BEFORE MILESTONE
            #------------------------
            [if] {VARIABLE_CONDITIONAL bm_turns not_equals $bm_milestone_scepter} {THEN(
                [message]
                    speaker=Delfador
                    message= _ "Hello, Konrad! I am most glad to see you again. Have you and Kalenz been taking good care of yourselves?"
                [/message]
                [message]
                    speaker=Konrad {KONRAD_VARIATION glad}
                    message= _ "Delfador, at last! So this is where you went off to! What quest could possibly bring you into this maze of tiny caves and tunnels?"
                [/message]
                [message]
                    speaker=Delfador
                    message= _ "Well, I suppose I must tell you eventually... Konrad, I am searching for the Sceptre of Fire."
                [/message]
                [message]
                    speaker=Konrad {KONRAD_VARIATION concerned}
                    message=_"The Scepter of Fire? The youngfolk at Blackwater Port always said that was just an old myth."
                [/message]
                {EXPLAIN_SCEPTRE before}
            )}
            #------------------------
            # DURING MILESTONE
            #------------------------
            {ELSE(
                [message]
                    speaker=Konrad {KONRAD_VARIATION glad}
                    message= _ "I have come, Delfador! So this is where you went off to! It is good to see you again, even if it is in such an unpleasant maze of caves and tunnels."
                [/message]
                [message]
                    speaker=Konrad {KONRAD_VARIATION concerned}
                    message= _ "You say you are searching for the Sceptre of Fire? The youngfolk at Blackwater Port always said that was just an old myth!"
                [/message]
                {EXPLAIN_SCEPTRE during}
            )} [/if]
        )
        #############################
        # MOVETO
        #############################
        (INCOMPLETE_MOVETO=
            #------------------------
            # BEFORE MILESTONE
            #------------------------
            [if] {VARIABLE_CONDITIONAL bm_turns not_equals $bm_milestone_scepter} {THEN(
                {MODIFY_UNIT id=Delfador facing sw}
                [if] {VARIABLE_CONDITIONAL "$($bm_milestone_scepter-$bm_turns)" equals 1} {THEN([message]
                    speaker=Delfador
                    message= _ "I have not located the Sceptre yet, but I am making progress. I shall send a messenger once we are ready to retrieve it — perhaps after your next battle."
                [/message])}{ELSE([message]
                    speaker=Delfador
                    message= _ "I have not located the Sceptre yet, but I am making progress. I shall send a messenger once we are ready to retrieve it — perhaps in $( $bm_milestone_scepter - $bm_turns ) battles’ time."
                [/message])}[/if]
                [message]
                    speaker=Delfador
                    message= _ "Finding the Sceptre will mark a major turning point in our adventure, Konrad. Before that happens, I urge you to take advantage of your freedom and continue exploring the Great Continent. You have done much good already, but there are countless others who still need your help."
                [/message]
                [message]
                    speaker=Delfador
                    message= _ "You may join me and hurry along the search if you so desire, but know that doing so will mark the end of your deeds in this region."
                [/message]
            )}
            #------------------------
            # MILESTONE REACHED
            #------------------------
            {ELSE(
                [if] {VARIABLE_CONDITIONAL bm_sceptre_explained_when equals before} {THEN(
                    [message]
                        speaker=Delfador
                        message=_"Excellent, you have come swiftly. Thank you, Konrad. I am certain I have located the object of our search, but we will need to work together to retrieve it."
                    [/message]
                    {MODIFY_UNIT id=Delfador facing sw}
                )} [/if]
                [message]
                    speaker=Delfador
                    message=_"Here is the tunnel down which lies the Sceptre of Fire; the symbol of kings. The surrounding caverns are crawling with all manner of monsters, doubtless drawn by its power."
                [/message]
                [message]
                    speaker=Delfador
                    message=_"Together, we shall clear the tunnels and claim your birthright once and for all."
                [/message]
            )} [/if]
        )
        #############################
        # COMPLETED
        #############################
        (COMPLETED_PRESTART=
            {CLEAR_VARIABLE bm_sceptre_explained_when}
        )
        (JUSTCOMPLETED_START=
            
        )
    }
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
