#textdomain wesnoth-h2tt

#define SCENARIO_TURN_LIMIT
3-#enddef


[scenario]
    id,map_file,name=15a_Valley_of_Death_part1,15a_Valley_of_Death_part1.map,_"Valley of Death, part 1"
    next_scenario,victory_when_enemies_defeated=00_The_Great_Continent,no
    {SCHEDULE_DYNAMIC_NIGHT OFFSET=-5}
    turns={SCENARIO_TURN_LIMIT}
          {SCENARIO_MUSIC battle-epic.ogg}
    {EXTRA_SCENARIO_MUSIC battle.ogg}
    {EXTRA_SCENARIO_MUSIC knalgan-theme.ogg}
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    {KONRAD_SIDE 75}
    
    #############################
    # WARRIOR MONKS
    #############################
    [side]
        side,controller,color=2,ai,brightorange
        type,id,name,facing="Shock Trooper",Kaelor,_"Brother Kaelor",se {MODIFICATIONS( {TRAIT_FEARLESS} {TRAIT_QUICK} )}
        gold,income,recruit={ON_DIFFICULTY4 30 40 50 50},{ON_DIFFICULTY4 1 2 4 4},"Heavy Infantryman" # 5 villages, and probably <5 upkeep
        team_name,user_team_name=konrad,_"Warrior Monks" {FLAG_VARIANT long}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 2 2}
    {STARTING_VILLAGES 2 5}
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI 2 defensive 0.4 0.25}
        {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME 2 3,4,5}
        {RETREAT_WHEN_WEAK 2 {ON_DIFFICULTY4 0-3 0-3 0-4 0-4} (
            {GOAL_LOCATION 3 x,y=12,8}
            {GOAL_LOCATION 2 x,y=10,8}
            {GOAL_LOCATION 1 x,y=14,5}
        )}
    [/event]
    
    #############################
    # UNDEAD
    #############################
    [side]
        side,controller,color=3,ai,white
        type,id,facing="Deathblade",leader3,"",sw
        gold,income,recruit={ON_DIFFICULTY4 15 30 60 60},{ON_DIFFICULTY4 -2 1 7 7},"Skeleton" # 3 villages, but probably >3 upkeep
        team_name,user_team_name=bad,_"Undead" {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 3 2}
    {STARTING_VILLAGES 3 7}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Skeleton Archer" {ON_DIFFICULTY4 1 1 2 2}} # 1 guard on all difficulties
    
    [side]
        side,controller,color=4,ai,white
        type,id,facing="Skeleton Archer",leader4,"",se
        gold,income,recruit={ON_DIFFICULTY4 10 20 40 40},{ON_DIFFICULTY4 -2 0 4 4},"Skeleton Archer" # 2 villages, but probably >2 upkeep
        team_name,user_team_name=bad,_"Undead" {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 4 2}
    {STARTING_VILLAGES 4 5}
    
    [side]
        side,controller,color=5,ai,white
        type,id,facing="Revenant",leader5,"",ne
        gold,income,recruit={ON_DIFFICULTY4 15 30 60 60},{ON_DIFFICULTY4 -2 1 7 7},"Skeleton" # 3 villages, but probably >3 upkeep
        team_name,user_team_name=bad,_"Undead" {FLAG_VARIANT6 ragged}
    [/side]
    {SILENTLY_LIMIT_LEADER_MOVES 5 2}
    {STARTING_VILLAGES 5 9}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Skeleton Archer" {ON_DIFFICULTY4 1 1 2 2}} # 1 guard on all difficulties
    
    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI 3,4,5 offensive 0.4 0.25}
        {VARY_AI_BY_SCHEDULE_ENEMY 3,4,5 1,2}
        {RETREAT_WHEN_WEAK 3 {ON_DIFFICULTY4 0-3 0-5 0-7 0-7} (
            {GOAL_LOCATION 3 x,y=31,4}
            {GOAL_LOCATION 3 x,y=33,6}
            {GOAL_LOCATION 2 x,y=29,3}
            {GOAL_LOCATION 2 x,y=34,7}
            {GOAL_LOCATION 1 x,y=34,7}
            {GOAL_LOCATION 1 x,y=26,3}
            {GOAL_LOCATION 1 x,y=35,8}
        )}
        {RETREAT_WHEN_WEAK 4 {ON_DIFFICULTY4 0-2 0-3 0-4 0-4} (
            {GOAL_LOCATION 3 x,y=28,11}
            {GOAL_LOCATION 2 x,y=38,11}
            {GOAL_LOCATION 2 x,y=26,8}
            {GOAL_LOCATION 1 x,y=27,14}
        )}
        {RETREAT_WHEN_WEAK 5 {ON_DIFFICULTY4 0-3 0-5 0-7 0-7} (
            {GOAL_LOCATION 3 x,y=13,23}
            {GOAL_LOCATION 3 x,y=15,23}
            {GOAL_LOCATION 2 x,y=14,19}
            {GOAL_LOCATION 2 x,y=10,22}
            {GOAL_LOCATION 1 x,y=17,22}
            {GOAL_LOCATION 1 x,y=16,19}
        )}
    [/event]
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {PLACE_IMAGE items/dwarven-keep-tile.png 27 10}
        
        #############################
        # WARRIOR MONKS
        #############################
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"}) 10  8 ({FACING sw}{ZONE_GUARDIAN 10  8 x,y,radius=11,6,4})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"}) 12  8 ({FACING sw}{ZONE_GUARDIAN 12  8 x,y,radius=11,6,4})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"}) 14  5 ({FACING se}{ZONE_GUARDIAN 14  5 x,y,radius=11,6,4})}
        
        #############################
        # UNDEAD
        #############################
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Skeleton Archer"   "Skeleton Archer"   "Skeleton Archer"   "Skeleton Archer"  }) 33  6 ({FACING se}{ZONE_GUARDIAN 33  6 x,y,radius=34,2,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Skeleton"          "Skeleton"          "Skeleton"          "Skeleton"         }) 29  3 ({FACING sw}{ZONE_GUARDIAN 29  3 x,y,radius=34,2,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"              "Skeleton"          "Skeleton"          "Skeleton"         }) 33  1 ({FACING sw}{ZONE_GUARDIAN 33  1 x,y,radius=34,2,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"              "none"              "Skeleton"          "Skeleton"         }) 35  8 ({FACING sw}{ZONE_GUARDIAN 35  8 x,y,radius=34,2,7})}
        {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"              "none"              "Skeleton"          "Skeleton"         }) 31  4 ({FACING sw}{ZONE_GUARDIAN 31  4 x,y,radius=34,2,7})}
        
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"              "Skeleton"          "Skeleton"          "Skeleton"         }) 26  8 ({FACING sw}{ZONE_GUARDIAN 26  8 x,y,radius=29,9,4})}
        {GENERIC_UNITC 4 ({ON_DIFFICULTY4 "none"              "none"              "Skeleton Archer"   "Skeleton Archer"  }) 30 11 ({FACING sw}{ZONE_GUARDIAN 30 11 x,y,radius=29,9,4})}
        
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "Skeleton Archer"   "Skeleton Archer"   "Skeleton Archer"   "Skeleton Archer"  }) 14 19 ({FACING se}{ZONE_GUARDIAN 14 19 x,y,radius=14,22,4})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"              "Skeleton"          "Skeleton"          "Skeleton"         }) 15 23 ({FACING sw}{ZONE_GUARDIAN 15 23 x,y,radius=14,22,4})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"              "none"              "Skeleton"          "Skeleton"         }) 17 22 ({FACING sw}{ZONE_GUARDIAN 17 22 x,y,radius=14,22,4})}
        {GENERIC_UNITC 5 ({ON_DIFFICULTY4 "none"              "none"              "Skeleton"          "Skeleton"         }) 10 22 ({FACING sw}{ZONE_GUARDIAN 10 22 x,y,radius=14,22,4})}
        
        
        #############################
        # KONRAD
        #############################
        {PUT_TO_RECALL_LIST id=Konrad}
        [if] {VARIABLE_CONDITIONAL s15a_from_west equals yes} {THEN(
            {SCROLL_TO 3 8}
        )} {ELSE(
            {SCROLL_TO 32 22}
        )} [/if]
    [/event]
    #######################################################################################################################################################
    #                                                                    PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        {DELAY 500}
        [message]
            speaker=foxtail1
            message=_"Hahaha, this town is great! Top-quality slaves, houses made with real shingles, and all the gold and silver in the world!"
        [/message]
        
        #############################
        # KONRAD ARRIVES
        #############################
        [if] {VARIABLE_CONDITIONAL s11_from_north equals yes} {THEN(
            {RECALL_XY Konrad 33 1} {MODIFY_UNIT id=Konrad facing sw} {DELAY 250}
            {MOVE_UNIT id=Konrad 32 3}
            {MODIFY_TERRAIN Ke 32 3} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 33 3} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 31 4} [redraw][/redraw] {DELAY 150}
            {MODIFY_TERRAIN Ce 32 4} [redraw][/redraw] {DELAY 150}
        )}
        {ELSE( # default spawn location - south
            {RECALL_XY Konrad 34 30} {MOVE_UNIT id=Konrad 34 29} {DELAY 250}
            {RECALL_KONRAD_AND_COMPANIONS 34 29} {DELAY 250}
        )} [/if]
        
        #############################
        # INTRODUCTORY DIALOGUE
        #############################
        {DELAY 500}
        [message]
            speaker=Konrad
            message=_"If Asheviere has truly given Elensefar to the orcs like they claim, it can only be because she expects them to ravage it."
        [/message]
        [message]
            speaker=Konrad
            message=_"She must believe the people will never submit to her rule, and would rather ruin them entirely than risk another revolt. How awful..."
        [/message]
        [message]
            speaker=Konrad
            message=_"We can’t let that happen. To arms, warriors!"
        [/message]
        [if] {VARIABLE_CONDITIONAL s11_from_north equals yes} {THEN(
            {RECALL_KONRAD_AND_COMPANIONS 32 5}
        )} {ELSE( # default spawn location - south
            {RECALL_KONRAD_AND_COMPANIONS 34 29}
        )} [/if]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat all enemy leaders"
                condition=win
            [/objective]
            {TURNS_RUN_OUT}
            {OBJECTIVES_HERODEATHS}
            [gold_carryover]
                carryover_percentage,bonus=40,no
            [/gold_carryover]
            [note]
                description= _ "Four thieves will join your attack once you capture any village on Elensefar island."
                [show_if]{VARIABLE_CONDITIONAL thieves_will_ambush equals yes}[/show_if]
            [/note]
        [/objectives]
    [/event]
    
    
    #############################
    # REGLOCK APPEARS
    #############################
    [event]
        name=turn 3
        #------------------------
        # INTRODUCE REGLOK
        #------------------------
        {FIND_COMPANION_AND_SAY
            MESSAGE_ALLARIL=_"Look there, boy! One o’ ’em city-folk’s gone yellow. I think he’s sneakin’ out to see us."
            MESSAGE_GENERIC=_"Look, someone’s fording the river! I think he’s sneaking out of the city towards us."
        }
        [if] {VARIABLE_CONDITIONAL s11_from_north equals yes} {THEN(
            {UNSTORE_NPC Reglok x,y=21,9 side,facing=5,ne}
            {MOVE_UNIT id=Reglok 28 6}
        )} {ELSE(
            {UNSTORE_NPC Reglok x,y=19,21 side,facing=5,se}
            {MOVE_UNIT id=Reglok 21 26}
        )} [/if]
        [message]
            speaker=Konrad
            message=_"Halt! Who goes there, friend or foe?"
        [/message]
        [message]
            speaker=Reglok
            message=_"Greetings, friend. I am Reglok, guildmaster of the Elensefar thieves. We would like to help you against the orcs."
        [/message]
        {FIND_COMPANION_AND_SAY
            MESSAGE_ALLARIL=_"Aye, sure ye do. An’ as soon as our backs are turned we’ll find yer fingers down our purses an’ yer knives stickin’ out o’ our spleens! What sort o’ chucklehead do ye take me for?"
            MESSAGE_GENERIC=_"Thieves, hmmm? Who says we can trust such as you?"
        }
        [message]
            speaker=Reglok
            message=_"We would understand if you didn’t trust us, of course, but it is in our mutual interest to rid the city of the orcs. Since Lord Maddock was dragged off in chains, our new overlords have done nothing but riot and steal. That infringes on our monopoly."
        [/message]
        [message]
            speaker=Reglok
            message=_"You shall find that there is honor, even among thieves. We served Maddock well, and if you can liberate Elensefar we shall do the same for you."
        [/message]
        [message]
            speaker=Konrad
            message=_"Yes, but where is your fighting force? How can you help us?"
        [/message]
        
        #------------------------
        # NORTH SHORE
        #------------------------
        [if] {VARIABLE_CONDITIONAL s11_from_north equals yes} {THEN(
            {UNSTORE_NPC Reglok x,y=21,9 side,facing=5,ne}
            {MOVE_UNIT id=Reglok 28 6}
            [message]
                speaker=Reglok
                message=_"There is a hidden ford on the southwest side of the city, but coming from the north that shall be of little use. Instead, we shall lay in wait until you give us a signal then ambush the orcs’ rear."
            [/message]
            [message]
                speaker=Reglok
                message=_"When you raise your blue banner over any building in the city proper, we will see the sign and attack from the city’s center. Expect four thieves to join the attack."
            [/message]
            [message]
                speaker=Konrad
                message=_"Agreed. But, will you be able to see our flag if it’s dark?"
            [/message]
            [message]
                speaker=Reglok
                message=_"Yes, we will see it. In fact, we prefer to fight at night. I pray you do not lead us into slaughter."
            [/message]
            [message]
                speaker=Konrad {KONRAD_VARIATION mad}
                message=_"Do not fear, friends. There will be a slaughter here, but it will be orcish blood staining the streets."
            [/message]
            {VARIABLE thieves_will_ambush yes}
            {STORE_NPC Reglok}
            [show_objectives][/show_objectives]
        )}
        #------------------------
        # SOUTH SHORE
        #------------------------
        {ELSE(
            [message]
                speaker=Reglok
                message=_"Information, child. There is a hidden ford on the southwest side of the city. Very few people know about it, least of all the orcs. I can show you how to cross."
            [/message]
            [message]
                speaker=Reglok
                message=_"Alternatively, we can lay in wait until you give us a signal then ambush the orcs’ rear. Expect four thieves to join the attack."
            [/message]
            [message]
                speaker=Konrad
                message=_""
                [option]
                    message=_"Help us infiltrate the city. We can do the rest."
                    [command]
                        [message]
                            speaker=Reglok
                            message=_"Very well. Watch exactly where I step."
                        [/message]
                        {MOVE_UNIT id=Reglok 17 25}
                        {MOVE_UNIT id=Reglok 21 27}
                        {MODIFY_TERRAIN Wwf 20,20 25,26}
                        {MODIFY_TERRAIN Wwf 18,19,19 27,28,27} [redraw][/redraw]
                        {DELAY 500}
                        {MOVE_UNIT id=Reglok 16 22}
                        {MODIFY_TERRAIN Wwf 15-18 24}
                        {MODIFY_TERRAIN Wwf 14,16,17 23,23,23}
                        {MODIFY_TERRAIN Wwf 16 22} [redraw][/redraw]
                        {DELAY 500}
                        {MOVE_UNIT id=Reglok 17 21}
                        {MODIFY_TERRAIN Wwf 17 22}
                        {MODIFY_TERRAIN Wwf 17-18 21} [redraw][/redraw]
                        {DELAY 500}
                        {MOVE_UNIT id=Reglok 16 20}
                        {MODIFY_TERRAIN Wwf 16-17 20}
                        {MODIFY_TERRAIN Ww  16 19}
                        {MODIFY_TERRAIN Ww  15 20-21} [redraw][/redraw]
                        {DELAY 500}
                        {MOVE_UNIT id=Reglok 17 18}
                        {MODIFY_TERRAIN Wwf 18 19}
                        {MODIFY_TERRAIN Ww  15 19}
                        {MODIFY_TERRAIN Ww  17,18 19,19}
                        {MODIFY_TERRAIN Ww  18,19 18,19} [redraw][/redraw]
                        {DELAY 500}
                        {MODIFY_UNIT id=Reglok facing se}
                        [message]
                            speaker=Reglok
                            message=_"You see? When the tide is at its lowest, the turbulent waters reveal a ford wide enough for two soldiers to march shoulder-to-shoulder. The orcs know not where to step, but now you do."
                        [/message]
                        [message]
                            speaker=Reglok
                            message=_"Good luck. You shall see me again if you succeed."
                        [/message]
                        {STORE_NPC Reglok}
                    [/command]
                [/option]
                [option]
                    message=_"I want you to reinforce us once we break through their line."
                    [command]
                        [message]
                            speaker=Reglok
                            message=_"Very well. When you raise your blue banner over any building in the city proper, we will see the sign and attack from the city’s center."
                        [/message]
                        [message]
                            speaker=Konrad
                            message=_"Agreed. But, will you be able to see our flag if it’s dark?"
                        [/message]
                        [message]
                            speaker=Reglok
                            message=_"Yes, we will see it. In fact, we prefer to fight at night. I pray you do not lead us into slaughter."
                        [/message]
                        [message]
                            speaker=Konrad {KONRAD_VARIATION mad}
                            message=_"Do not fear, friends. There will be a slaughter here, but it will be orcish blood staining the streets."
                        [/message]
                        {VARIABLE thieves_will_ambush yes}
                        {STORE_NPC Reglok}
                        [show_objectives][/show_objectives]
                    [/command]
                [/option]
            [/message]
        )} [/if]
    [/event]
    
    
    #############################
    # ORCS SURPRISED BY FORD
    #############################
    [event]
        name=moveto
        {FILTER( side,defense=1,60-100 {FILTER_LOCATION x,y,radius=17,19,1} )}
        [message]
            speaker=foxtail1
            message=_"What!? Since when did you vermin learn to walk on water?"
        [/message]
    [/event]
    
    
    #############################
    # THIEVES AMBUSH
    #############################
    [event]
        name=capture
        {FILTER( side=1 {FILTER_LOCATION( x,y,radius=15,12,9 )})}
        {FILTER_CONDITION({VARIABLE_CONDITIONAL thieves_will_ambush equals yes})}
        {UNSTORE_NPC Reglok x,y=25,16 side,facing=5,se}
        [message]
            speaker=Reglok
            message=_"That’s their banner! Let’s expel these invaders. Today, the city is ours again!"
        [/message]
        {STORE_NPC Reglok}
        {GENERIC_UNIT 1 Thief 24 15} {ANIMATE} {GENDER female}
        {GENERIC_UNIT 1 Thief 27 15} {ANIMATE}
        {GENERIC_UNIT 1 Thief 22 14} {ANIMATE} {GENDER female}
        {GENERIC_UNIT 1 Thief 28 16} {ANIMATE} {GENDER female}
        {CLEAR_VARIABLE thieves_will_ambush} # remove the note from the objectives
        [show_objectives][/show_objectives]
    [/event]
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # FIRST LEADER KILLED
    #############################
    [event]
        name=last breath
        {FILTER id=foxtail1,foxtail2}
        [message]
            speaker=unit
            message=_"Arrgh! Lousy humans..."
        [/message]
        
        #############################
        # ALL LEADERS KILLED
        #############################
        [event]
            name=last breath
            {FILTER id=foxtail1,foxtail2}
            [message]
                speaker=unit
                message=_"I’m not dying! True orcs never die! I just... need a moment..."
            [/message]
            [event]
                name=die
                {UNSTORE_NPC Reglok x,y=25,16 side,facing=5,se}
                {GENERIC_UNIT 5 Thief 27 16} {ANIMATE} {GENDER female} {ROLE thief}
                [message]
                    speaker=Reglok
                    message=_"Well done, well done! Elensefar is finally rid of those loathsome orcs."
                [/message]
                [message]
                    speaker=Konrad
                    message=_"You walk free once more! But for how long? Once we leave, who will remain to defend the walls?"
                [/message]
                [message]
                    speaker=Reglok
                    message=_"They say the best defense is a good offense, no? I place the thieves of Elensefar in your service, your exaltedness, ready to take the fight to the dark queen."
                [/message]
                {NEW_RECRUIT2 (Thief) _"You can now recruit Thieves!" human-outlaws/thief.png human-outlaws/thief+female.png}
                [message]
                    speaker=Reglok
                    message=_"I myself must of course remain behind to oversee the city. You understand."
                [/message]
                [message]
                    speaker=Konrad
                    message=_"All too well. Rule wisely, Reglok, for I shall return to Elensefar once Asheviere is defeated and I am king. Prove yourself a better lord than the orcs."
                [/message]
                
                {CLEAR_VARIABLE s10_from_north,thieves_will_ambush}
                [endlevel]
                    result=victory
                    {NEW_GOLD_CARRYOVER 40}
                [/endlevel]
            [/event]
        [/event]
    [/event]
    
    
    #############################
    # TIME OVER
    #############################
    [event]
        name=turn $({SCENARIO_TURN_LIMIT}-4)
        [message]
            speaker=Konrad
            message=_"Between the siege and our attack, Elensefar has been badly damaged. Countless townsfolk will die if we cannot finish things off soon!"
        [/message]
    [/event]
    [event]
        name=side 1 turn {SCENARIO_TURN_LIMIT} end
        [message]
            speaker=Konrad
            message=_"Our battle has dragged on too long; Elensefar has become too badly destroyed. Even if we defeat these orcs, the city will never-again return to its former splendor..."
        [/message]
    [/event]
[/scenario]




#undef ELENSEFAR_AFTER_AVOID_AREA
#undef FOXTAIL_SIDE
#undef SCENARIO_TURN_LIMIT
